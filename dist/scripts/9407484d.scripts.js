"use strict";var app=angular.module("mfAngularApp",["ngRoute","ui.bootstrap"]);app.config(["$routeProvider","$locationProvider",function(a,b){var c={site:["$route","DataService",function(a,b){return b.getSite()}]};a.when("/edit/:lang/:url/:container?/:widget?",{templateUrl:"/views/edit.html",controller:"PageCtrl",resolve:c}).when("/edit",{redirectTo:"/edit/pl/home"}).when("/add/:lang/:url/:container?/:widget?",{templateUrl:"/views/edit.html",controller:"AddCtrl",resolve:c}).when("/add",{redirectTo:"/add/pl/home"}).when("/:lang/:url",{templateUrl:"/views/preview.html",controller:"PageCtrl",resolve:c}).otherwise({redirectTo:"/pl/home"}),b.html5Mode(!0)}]),app.service("ExtrasService",["$rootScope",function(){return{guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})}}}]),app.service("EditorDataService",["$rootScope","$http","$q",function(a,b,c){var d=function(a,b){for(var c in a)e[b]=a},e={widgets:null,languages:null,getAllData:function(){if(this.widgets&&this.languages)return c.when(!0);var a=[];return a.push(b({method:"GET",url:"/data/widgets.json"}).success(function(a){d(a,"widgets"),console.log("------------------------------g----------"),console.log(e.widgets)})),a.push(b({method:"GET",url:"/data/languages.json"}).success(function(a){d(a[0],"languages"),console.log("------------------------------g----------"),console.log(e.languages)})),c.all(a)},debugEditor:function(){console.log(this.widgets),console.log(this.languages)}};return e}]),app.factory("DataService",["$rootScope","$http","$route","$routeParams","$q","$window","ExtrasService",function(a,b,c,d,e,f,g){var h=function(a){var b=angular.fromJson(localStorage[a]);return console.log("loaded form local storage"),b},i=function(a){j.site||(j.site={});for(var b in a)j.site[b]=a[b];console.log("updatd site var"),console.log(j.site)},j={site:null,availableWidgets:null,state:{cached:!1},getAvailableWidgets:function(){return this.availableWidgets},getContainerGuid:function(a,b){return this.site.pages[a].containers[b]},debugSite:function(){for(var a in this.site)console.log(a+":"),console.log(this.site[a]);console.log("current page containers:");for(var b=d.url,c=this.site.pages[b]?this.site.pages[b].containers:this.site.pages.home.containers,e=c.length,f=0;e>f;f++)console.log(this.site.containers[c[f]])},saveSite:function(){localStorage.MF=angular.toJson(this.site,!0),localStorage.removeItem("MF-CACHE")},loadSite:function(){var a=h("MF");i(a)},loadCache:function(){var a=h("MF-CACHE");i(a),this.setCached(!1)},setCached:function(a){this.state.cached=a},clearLocal:function(){localStorage.removeItem("MF"),localStorage.removeItem("MF-CACHE"),console.log("localStorage cleared")},getSite:function(){var a;return this.site?a=e.when(!0):("undefined"==typeof localStorage.MF?a=b({method:"GET",url:"/data/data.json"}).success(function(a){console.log("getting site from JSON data"),console.log(a[0]),i(a[0])}):(console.log("site loaded from server [* but server is in localStorage :P]"),this.loadSite(),a=e.when(!0)),"undefined"!=typeof localStorage["MF-CACHE"]&&(console.log("cached site present"),this.setCached(!0))),a},getPages:function(){return this.site?this.site.pages:[]},getContainers:function(a){var a=a||d.url;if(this.site){for(var b=[],c=this.site.pages[a]?this.site.pages[a].containers:this.site.pages.home.containers,e=c.length,f=0;e>f;f++)b.push(this.site.containers[c[f]]);return b}return[]},appendContainer:function(a,b){var c=d.url;if(c&&this.site.pages[c]){var e=this.site.pages[c].containers.indexOf(a);e>-1&&this.site.pages[c].containers.splice(e,1),this.site.pages[c].containers.splice(b,0,a),console.log("container added"),console.log(this.site.pages[c].containers),console.log("*************")}else console.log(c),console.error('"page" parameter error')},addContainer:function(a){var a=a||this.site.pages[d.url].containers.length,b=g.guid();this.site.containers[b]={guid:b,layout:!1,widgets:[]},this.appendContainer(b,a)},removeContainerByGuid:function(a){this.site.pages.length;console.log("removing container by guid"),console.log(this.site.pages);for(var b in this.site.pages){console.log(b),console.log(this.site.pages[b].containers);var c=this.site.pages[b].containers.indexOf(a);c>-1&&this.site.pages[b].containers.splice(c,1),console.log(this.site.pages[b].containers)}k()},removeContainer:function(a){var b=d.url,c=this.site.pages[b].containers[a];delete this.site.containers[c],this.removeContainerByGuid(c)},appendWidget:function(a,b,c){var e=d.url,f=this.getContainerGuid(e,b);return c>this.site.containers[f].widgets.length?(console.error("[ADD] position bigger than array length"),!1):(this.site.containers[f].widgets.splice(c,0,a),void k())},removeWidget:function(a,b){var c=d.url,e=this.getContainerGuid(c,a);this.site.containers[e].widgets.splice(b,1),k()},moveWidget:function(a,b){var e=d.url,f=this.getContainerGuid(e,a[0]),g=angular.copy(this.site.containers[f].widgets[a[1]]);this.removeWidget(a[0],a[1]),this.appendWidget(g,b[0],b[1]),c.reload()}},k=function(){localStorage["MF-CACHE"]=angular.toJson(j.site,!0)};return f.onbeforeunload=function(){return LiveReload||"undefined"==typeof localStorage["MF-CACHE"]?null:function(){return"Twoja stronia nie została zapisana, czy na pewno chcesz opuścić edytor?"}},console.log("just befeore returning dataService"),j}]),app.directive("container",["$rootScope","DataService",function(a,b){return{restrict:"E",templateUrl:"/views/container.html",replace:!0,link:function(a,c){var d=function(a){var b=a.parent(".container");return $(".widget",b).index(a)},e=function(a){var b=a.parent(".container");return $("#main .container").index(b)},f=function(a){return[e(a),d(a)]},g=function(a){$.data(a,"widgetCoords",f(a))},h=function(a){return $.data(a,"widgetCoords")};a.editorMode&&angular.element(c).sortable({connectWith:".container",handle:".drag-handle",placeholder:"drag-placeholder",forcePlaceholderSize:!0,start:function(a,b){g(b.item)},stop:function(){$(".drag-handle",c).mouseleave()},update:function(a,c){c.sender||b.moveWidget(h(c.item),f(c.item))}})}}}]),app.directive("widget",function(){return{restrict:"E",templateUrl:"/views/widget.html",replace:!0}}),app.directive("widgetSwitches",function(){return{restrict:"E",templateUrl:"/views/widgetswitches.html",replace:!0,link:function(a,b){var c=$(b).parent(".widget");a.editorMode&&$(b).hover(function(){c.append('<div class="element-overlay" />')},function(){$(".element-overlay",c).remove()})}}}),app.directive("text",function(){return{restrict:"E",templateUrl:"/views/widgets/text.html",replace:!0}}),app.directive("dynamicStyle",function(){return{restrict:"A",scope:{css:"="},templateUrl:"/views/style.html",replace:!0}}),app.filter("inArray",["$filter",function(a){return function(b,c,d){return c?a("filter")(b,function(a){return-1!=c.indexOf(a[d])}):void 0}}]),angular.module("mfAngularApp").controller("SiteCtrl",["$rootScope","$scope","$routeParams","DataService","EditorDataService",function(a,b,c,d,e){b.state=d.state,b.lang="pl_PL",e.getAllData().then(function(){b.editorData={widgets:e.widgets,languages:e.languages},b.lang=e.currentLang,console.log(b.editorData)}),b.$on("$routeChangeSuccess",function(){"undefined"!=typeof c.url?(b.currentPage=c.url,b.lang=c.lang,b.site=d.site,b.title=d.site.pages[b.currentPage].name):console.log("routeParams undefined!!!!")}),b.$watchCollection("site",function(a,b){console.log("[SiteCtrl] watching for site changes: [oldData/newData] ----------------"),console.log(b),console.log(a),console.log("-------------------------------------------------------------------")}),b.debugEditor=function(){e.debugEditor()},b.loadCache=function(){$("#dialog_cached").remove(),d.loadCache()},b.closeCacheDialog=function(){$("#dialog_cached").remove(),d.setCached(!1)}}]),angular.module("mfAngularApp").controller("PageCtrl",["$scope","$http","$routeParams","$location","DataService","ExtrasService",function(a,b,c,d,e){a.editorMode=0==d.path().search(/\/edit\/|\/add\//),a.addContainer=function(){e.addContainer()},a.removeContainer=function(a){e.removeContainer(a)},a.removeWidget=function(a,b){e.removeWidget(a,b)},a.debugSite=function(){e.debugSite()},a.clearLocal=function(){e.clearLocal()},a.saveSite=function(){e.saveSite()},a.loadSite=function(){e.loadSite()},a.$watchCollection("site",function(a,b){console.log("watching for site changes: [oldData/newData] ----------------"),console.log(b),console.log(a),console.log("-------------------------------------------------------------------")})}]),angular.module("mfAngularApp").controller("AddCtrl",["$scope","$http","$routeParams","$location","DataService","ExtrasService",function(a,b,c,d,e){switch(a.editorMode=!0,a.addMode=!0,a.addType="page",a.widgets=[],b({method:"GET",url:"/data/widgets.json"}).success(function(b){console.log("---http-----"),a.widgets=b,console.log(a.widgets)}),a.addWidget=function(b){var f=c.container,g=c.widget;console.log("adding widget: "+b),console.log("to container: "+f);var h=a.widgets[b],i={type:h.type};for(var j in a.site.languages)i[a.site.languages[j]]=h.langs;angular.extend(i,h.params),console.log(i),e.appendWidget(i,f,g),console.log("xx"),d.path("edit/"+c.lang+"/"+c.url),console.log("xx")},Object.keys(c).length){case 2:break;case 3:a.addType="container";break;case 4:a.addType="widget";break;default:console.error("[ADD] wrong params!!")}}]);